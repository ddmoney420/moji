---
type: code
status: completed
labels:
- testing
- terminal-detection
- high-priority
target_files:
- internal/terminal/terminal.go
- internal/terminal/terminal_test.go
model: claude-haiku-4-5-20251001
---
# Add Test Coverage for Terminal Capability Detection

## Problem Description

The `internal/terminal/` package provides critical terminal feature detection but has **zero test coverage**. This package determines:

1. **Color Level Support:** 8, 256, or 16M (true color) color capabilities
2. **Protocol Availability:** Which image protocols the terminal supports
3. **Terminal Capabilities:** UTF-8 support, mouse support, focus tracking
4. **Feature Inference:** Based on TERM, COLORTERM, and other environment variables

The 374-line terminal.go file is untested, meaning:
- Color level detection could silently fail
- Protocol availability might be incorrectly inferred
- Feature detection logic has no validation
- Edge cases (unknown TERM values, missing env vars) are uncovered

This is high-priority because terminal detection directly affects:
- Which image protocols are used (imgproto selection)
- How colors are rendered (color quantization strategy)
- Feature availability in TUI and other commands

## Solution Approach

Create a comprehensive test suite covering:

1. **Color Level Detection Tests**
   - COLORTERM environment variable parsing
   - TERM-based color inference (xterm-256color, xterm-kitty, etc.)
   - Fallback to default when info unavailable
   - Monochrome terminal detection

2. **Protocol Capability Tests**
   - Sixel support detection
   - Kitty protocol detection
   - iTerm2 detection
   - Virtual terminal sequence support

3. **Environment Variable Tests**
   - UTF-8 support detection (LC_ALL, LANG, LC_CTYPE)
   - Mouse support (xterm mouse protocol)
   - Focus tracking capability
   - OSC and CSI sequence support

4. **Edge Case Tests**
   - Unknown TERM values
   - Missing environment variables
   - Conflicting/contradictory signals
   - Non-standard terminal variations

5. **Integration Tests**
   - Real system detection validation
   - Mock environment combinations
   - Fallback behavior verification

## Acceptance Criteria

- [x] Create `internal/terminal/terminal_test.go` with unit tests
- [x] Test `ColorLevel()` with various TERM and COLORTERM values
- [x] Test color level fallback logic (256 â†’ 8, etc.)
- [x] Test protocol detection for Sixel, Kitty, iTerm2
- [x] Test UTF-8 support detection via LC_ALL, LANG, LC_CTYPE
- [x] Test environment variable edge cases (missing, empty, invalid)
- [x] Test known TERM values (xterm, tmux, screen, linux, dumb, etc.)
- [x] Test unknown/custom TERM values with sensible defaults
- [x] Achieve minimum 80% coverage for terminal package
- [x] All tests pass with `go test ./internal/terminal/...`
- [x] Run `go vet ./internal/terminal/` with no errors

## Technical Notes

### Key Functions to Test
- `ColorLevel() ColorDepth` - Determine available colors
- `SupportsProtocol(p Protocol) bool` - Check protocol availability
- `SupportsUTF8() bool` - Check UTF-8 support
- `SupportsMouse() bool` - Check mouse protocol support
- `SupportsOSC() bool` - Check OSC sequence support
- `SupportsFocus() bool` - Check focus tracking support

### Test Data Requirements

**TERM Values to Test:**
- `xterm-256color` (default, 256 colors)
- `xterm-kitty` (Kitty terminal, true color)
- `xterm` (basic, 8 colors)
- `tmux` (256 colors via nested detection)
- `screen` (256 colors via nested detection)
- `linux` (8 colors, VT102)
- `dumb` (monochrome, basic)
- `vt100`, `vt102`, `vt220` (legacy)
- `iterm` (iTerm2, true color)
- `foot` (foot terminal, true color + Sixel)
- Unknown value (should fallback gracefully)

**COLORTERM Values to Test:**
- `truecolor` (24-bit color)
- `24bit` (24-bit color alias)
- `256color` (256 color)
- Missing/empty
- Invalid values

**Environment Variable Combinations:**
- UTF-8: LC_ALL=en_US.UTF-8, LANG=en_US.UTF-8, LC_CTYPE=UTF-8
- Non-UTF-8: LC_ALL=C, LANG=C, LC_CTYPE=ASCII
- Missing all (should default)
- Conflicting (C.UTF-8)

### Estimated Effort
- Color level tests: 1-2 days
- Protocol detection tests: 1-2 days
- Environment variable tests: 1-2 days
- Edge case/integration tests: 1 day
- Total: 3-5 days

## Related Specs
- Depends on: None
- Enables: "Image Protocol Testing" (builds on detection results)
- Related to: "Configuration System Testing"