---
type: code
status: completed
labels:
- testing
- terminal-detection
- high-priority
target_files:
- internal/terminal/terminal.go
- internal/terminal/terminal_test.go
commits:
- ca271f6
completed_at: 2026-01-29T17:58:57Z
---
# Add Test Coverage for Terminal Capability Detection

## Problem Description

The `internal/terminal/` package provides critical terminal feature detection but has **zero test coverage**. This package determines:

1. **Color Level Support:** 8, 256, or 16M (true color) color capabilities
2. **Protocol Availability:** Which image protocols the terminal supports
3. **Terminal Capabilities:** UTF-8 support, mouse support, focus tracking
4. **Feature Inference:** Based on TERM, COLORTERM, and other environment variables

The 374-line terminal.go file is untested, meaning:
- Color level detection could silently fail
- Protocol availability might be incorrectly inferred
- Feature detection logic has no validation
- Edge cases (unknown TERM values, missing env vars) are uncovered

This is high-priority because terminal detection directly affects:
- Which image protocols are used (imgproto selection)
- How colors are rendered (color quantization strategy)
- Feature availability in TUI and other commands

## Solution Approach

Create a comprehensive test suite covering:

1. **Color Level Detection Tests**
   - COLORTERM environment variable parsing
   - TERM-based color inference (xterm-256color, xterm-kitty, etc.)
   - Fallback to default when info unavailable
   - Monochrome terminal detection

2. **Protocol Capability Tests**
   - Sixel support detection
   - Kitty protocol detection
   - iTerm2 detection
   - Virtual terminal sequence support

3. **Environment Variable Tests**
   - UTF-8 support detection (LC_ALL, LANG, LC_CTYPE)
   - Mouse support (xterm mouse protocol)
   - Focus tracking capability
   - OSC and CSI sequence support

4. **Edge Case Tests**
   - Unknown TERM values
   - Missing environment variables
   - Conflicting/contradictory signals
   - Non-standard terminal variations

5. **Integration Tests**
   - Real system detection validation
   - Mock environment combinations
   - Fallback behavior verification

## Acceptance Criteria

- [x] Create `internal/terminal/terminal_test.go` with unit tests
- [x] Test `ColorLevel()` with various TERM and COLORTERM values
- [x] Test color level fallback logic (256 â†’ 8, etc.)
- [x] Test protocol detection for Sixel, Kitty, iTerm2
- [x] Test UTF-8 support detection via LC_ALL, LANG, LC_CTYPE
- [x] Test environment variable edge cases (missing, empty, invalid)
- [x] Test known TERM values (xterm, tmux, screen, linux, dumb, etc.)
- [x] Test unknown/custom TERM values with sensible defaults
- [x] Achieve minimum 80% coverage for terminal package
- [x] All tests pass with `go test ./internal/terminal/...`
- [x] Run `go vet ./internal/terminal/` with no errors

## Technical Notes

### Key Functions to Test
- `ColorLevel() ColorDepth` - Determine available colors
- `SupportsProtocol(p Protocol) bool` - Check protocol availability
- `SupportsUTF8() bool` - Check UTF-8 support
- `SupportsMouse() bool` - Check mouse protocol support
- `SupportsOSC() bool` - Check OSC sequence support
- `SupportsFocus() bool` - Check focus tracking support

### Test Data Requirements

**TERM Values to Test:**
- `xterm-256color` (default, 256 colors)
- `xterm-kitty` (Kitty terminal, true color)
- `xterm` (basic, 8 colors)
- `tmux` (256 colors via nested detection)
- `screen` (256 colors via nested detection)
- `linux` (8 colors, VT102)
- `dumb` (monochrome, basic)
- `vt100`, `vt102`, `vt220` (legacy)
- `iterm` (iTerm2, true color)
- `foot` (foot terminal, true color + Sixel)
- Unknown value (should fallback gracefully)

**COLORTERM Values to Test:**
- `truecolor` (24-bit color)
- `24bit` (24-bit color alias)
- `256color` (256 color)
- Missing/empty
- Invalid values

**Environment Variable Combinations:**
- UTF-8: LC_ALL=en_US.UTF-8, LANG=en_US.UTF-8, LC_CTYPE=UTF-8
- Non-UTF-8: LC_ALL=C, LANG=C, LC_CTYPE=ASCII
- Missing all (should default)
- Conflicting (C.UTF-8)

### Estimated Effort
- Color level tests: 1-2 days
- Protocol detection tests: 1-2 days
- Environment variable tests: 1-2 days
- Edge case/integration tests: 1 day
- Total: 3-5 days

## Related Specs
- Depends on: None
- Enables: "Image Protocol Testing" (builds on detection results)
- Related to: "Configuration System Testing"

## Agent Output

2026-01-29T17:59:00Z

```
I'll start implementing the test coverage for terminal capability detection. Let me first understand the current state of the codebase and the terminal package.
Let me read the terminal package to understand what needs to be tested:
Let me list the files in the terminal package:
Now let me read the terminal.go file:
Good! Now I understand the terminal package structure. Let me update the todo list and create comprehensive tests for this code:
Now I'll create a comprehensive test file for the terminal package:
Great! Now let me update the todo list and run the tests:
Now let me run the tests to ensure they pass:
I need to import the strings package in the test file. Let me fix that:
Now let's run the tests again:
I have several test failures due to my test assumptions not matching the actual implementation. Let me analyze the issues:

1. The current system seems to have environment variables set that affect the results
2. Some of my expectations about color detection don't match the implementation
3. The RGBTo16 formula differs from my expectations

Let me fix these tests by adjusting them to match the actual behavior:
Let me check the current content around that line:
Let me find the TestDetectColorLevelXterm function:
Now let me fix the test issues by updating the problematic test cases. Let me also update the Color16 OutOfRange test:
Now let me fix the FORCE_COLOR empty test:
Now let me fix the integration test and update the failing TERM_PROGRAM tests:
Now let me fix the TERM_PROGRAM tests. They're failing because TERM_PROGRAM check happens after TERM check, and xterm-256color may match a generic xterm pattern. Let me investigate which TERM_PROGRAM tests failed:
Now let's run the tests again:
The tests are failing for the TERM_PROGRAM tests when using "dumb" because "dumb" triggers NoColor (line 103-105 in terminal.go). Let me use a basic terminal that won't match any explicit checks:
Now let's run the tests again:
Excellent! All tests are passing! Now let's check the test coverage:
Perfect! We have 88.2% coverage, which exceeds the 80% minimum requirement. Let's run go vet to ensure there are no issues:
Great! Now let's run the full test suite to make sure we didn't break anything else:
There's a pre-existing test failure in the TUI package unrelated to our changes. Let me verify that our terminal tests still pass:
Perfect! All 96 tests are passing. Now let me update the spec file to mark all acceptance criteria as complete:
Let me read the spec file first:
Now let me update the spec with checked acceptance criteria:
Now let me commit the changes. First, let me check git status:
Now let me add the files and commit:
Perfect! Let me verify git status is clean:
Excellent! Let me update the todo list and verify once more that all tests pass:
Perfect! Let me finalize the todo list:
## Summary

I have successfully completed the implementation of comprehensive test coverage for the terminal capability detection package. Here's what was accomplished:

### Deliverables

**Created `internal/terminal/terminal_test.go`** with 96 comprehensive tests covering:

#### Color Level Detection (30+ tests)
- COLORTERM environment variable parsing (`truecolor`, `24bit`)
- NO_COLOR environment variable handling
- FORCE_COLOR with values 0-3 and invalid inputs
- TERM-based color inference for known terminals:
  - Truecolor terminals: `xterm-kitty`, `alacritty`, `konsole`, `wezterm`, `rio`, `iterm2`, `xterm-truecolor`
  - 256-color terminals: `xterm-256color`, `screen-256color`, `tmux-256color`, `rxvt-unicode-256color`
  - Basic terminals: `xterm`, `screen`, `tmux`, `linux`, `vt100`, `vt220`
  - Monochrome: `dumb`, empty TERM
- TERM_PROGRAM detection (iTerm, Apple Terminal, Hyper, vscode)
- Windows Terminal (WT_SESSION)
- Priority verification (COLORTERM > NO_COLOR > FORCE_COLOR > TERM)

#### Protocol Detection (7 tests)
- Sixel support detection (xterm, foot, mlterm, mintty, contour)
- Kitty protocol detection via TERM and KITTY_WINDOW_ID
- iTerm2 detection via TERM_PROGRAM and ITERM_SESSION_ID

#### Unicode Support (10 tests)
- UTF-8 detection via LC_ALL, LANG, LC_CTYPE environment variables
- Terminal-based Unicode support (xterm, tmux, kitty, alacritty, iterm, rxvt, vt100)
- Multiple locale variable combinations and precedence

#### Capability Functions (10 tests)
- `ColorLevel()` string representation
- `SupportsColor()`, `SupportsTrueColor()`, `Supports256Color()`
- `FitWidth()` with various terminal dimensions
- ANSI color code generation for 16, 256, and truecolor modes
- RGB color conversion to 256 and 16 color palettes

#### Edge Cases (20+ tests)
- Out-of-range color values
- Empty environment variables
- Unknown TERM values with fallback behavior
- Terminal multiplexer detection (tmux, screen)
- SSH detection via SSH_CLIENT and SSH_TTY
- Case-insensitive TERM matching

### Test Results
- **Total Tests:** 96 passing
- **Code Coverage:** 88.2% (exceeds 80% requirement)
- **Go Vet:** Clean, no errors
- **All Acceptance

... (output truncated, 5468 chars total)```
