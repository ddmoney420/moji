---
type: code
status: ready
labels:
- testing
- terminal-graphics
- high-priority
target_files:
- internal/imgproto/imgproto.go
- internal/imgproto/imgproto_test.go
---

# Add Comprehensive Test Suite for Terminal Image Protocols

## Problem Description

The `internal/imgproto/` package implements support for terminal graphics protocols (Sixel, Kitty, iTerm2) but has **zero test coverage**. This is a critical gap because:

1. **Core Functionality:** Terminal image rendering is a flagship feature of moji
2. **Protocol Complexity:** Each protocol has different encoding, color quantization, and chunking requirements
3. **Environmental Detection:** Auto-detection logic based on environment variables is untested
4. **Regression Risk:** No tests means protocol changes could silently break user workflows

The 351-line imgproto.go file contains:
- Sixel implementation with palette quantization
- Kitty graphics protocol with base64 encoding and chunking (4096 bytes/chunk)
- iTerm2 inline image protocol with PNG encoding
- Auto-detection logic checking TERM, KITTY_WINDOW_ID, and ITERM_SESSION_ID
- Image scaling and color quantization

## Solution Approach

Create a comprehensive test suite covering:

1. **Protocol Unit Tests**
   - Sixel output format validation
   - Kitty protocol chunking and encoding
   - iTerm2 PNG generation
   - Color quantization accuracy

2. **Auto-Detection Tests**
   - Environment variable parsing (TERM, KITTY_WINDOW_ID, ITERM_SESSION_ID)
   - Fallback ordering (Kitty → iTerm2 → Sixel → ASCII)
   - Edge cases (missing variables, conflicting signals)

3. **Integration Tests**
   - Round-trip encoding/output validation
   - Color preservation across protocols
   - Image scaling correctness

4. **Fuzzing Tests** (optional but recommended)
   - Invalid terminal environment values
   - Malformed image data
   - Edge case image sizes

## Acceptance Criteria

- [ ] Create `internal/imgproto/imgproto_test.go` with unit tests
- [ ] Test all four protocols (Sixel, Kitty, iTerm2, ASCII fallback)
- [ ] Test `Detect()` function with environment variable combinations
- [ ] Test `Render()` function for all protocols with sample images
- [ ] Test color quantization logic
- [ ] Test image scaling logic
- [ ] Test protocol-specific chunking and encoding
- [ ] Achieve minimum 80% coverage for imgproto package
- [ ] All tests pass with `go test ./internal/imgproto/...`
- [ ] Run `go vet ./internal/imgproto/` with no errors

## Technical Notes

### Key Functions to Test
- `Detect() Protocol` - Environment-based protocol detection
- `Render() string` - Convert image.Image to protocol-specific string
- `quantizeColors(palette) []color.Color` - Color quantization
- Protocol-specific rendering (sixelRender, kittyRender, iTerm2Render)

### Test Data Requirements
- Small test image (16x16 pixels, 8 colors)
- Medium test image (64x64 pixels, 256 colors)
- Edge cases: 1x1, 1000x1000, single color, rainbow

### Environment Variable Test Cases
- `TERM=xterm-256color` + no Kitty/iTerm2 variables → Sixel
- `TERM=xterm-kitty` → Kitty
- `KITTY_WINDOW_ID=1` (any TERM) → Kitty
- `ITERM_SESSION_ID=xxx` (any TERM) → iTerm2
- `TERM=vt100` (no modern protocols) → ASCII fallback
- Multiple signals present → correct priority order

### Estimated Effort
- Unit tests: 3-4 days
- Auto-detection tests: 2-3 days
- Integration/fuzzing: 1 day
- Total: 5-8 days

## Related Specs
- Depends on: None
- Enables: "Extended Terminal Protocol Support" (WezTerm, Terminology, VT340)
- Related to: "Terminal Capability Detection Testing"
