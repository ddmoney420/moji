---
type: code
status: completed
labels:
- testing
- terminal-graphics
- high-priority
target_files:
- internal/imgproto/imgproto.go
- internal/imgproto/imgproto_test.go
commits:
- 09052d1
completed_at: 2026-01-29T18:06:54Z
---
# Add Comprehensive Test Suite for Terminal Image Protocols

## Problem Description

The `internal/imgproto/` package implements support for terminal graphics protocols (Sixel, Kitty, iTerm2) but has **zero test coverage**. This is a critical gap because:

1. **Core Functionality:** Terminal image rendering is a flagship feature of moji
2. **Protocol Complexity:** Each protocol has different encoding, color quantization, and chunking requirements
3. **Environmental Detection:** Auto-detection logic based on environment variables is untested
4. **Regression Risk:** No tests means protocol changes could silently break user workflows

The 351-line imgproto.go file contains:
- Sixel implementation with palette quantization
- Kitty graphics protocol with base64 encoding and chunking (4096 bytes/chunk)
- iTerm2 inline image protocol with PNG encoding
- Auto-detection logic checking TERM, KITTY_WINDOW_ID, and ITERM_SESSION_ID
- Image scaling and color quantization

## Solution Approach

Create a comprehensive test suite covering:

1. **Protocol Unit Tests**
   - Sixel output format validation
   - Kitty protocol chunking and encoding
   - iTerm2 PNG generation
   - Color quantization accuracy

2. **Auto-Detection Tests**
   - Environment variable parsing (TERM, KITTY_WINDOW_ID, ITERM_SESSION_ID)
   - Fallback ordering (Kitty → iTerm2 → Sixel → ASCII)
   - Edge cases (missing variables, conflicting signals)

3. **Integration Tests**
   - Round-trip encoding/output validation
   - Color preservation across protocols
   - Image scaling correctness

4. **Fuzzing Tests** (optional but recommended)
   - Invalid terminal environment values
   - Malformed image data
   - Edge case image sizes

## Acceptance Criteria

- [x] Create `internal/imgproto/imgproto_test.go` with unit tests
- [x] Test all four protocols (Sixel, Kitty, iTerm2, ASCII fallback)
- [x] Test `Detect()` function with environment variable combinations
- [x] Test `Render()` function for all protocols with sample images
- [x] Test color quantization logic
- [x] Test image scaling logic
- [x] Test protocol-specific chunking and encoding
- [x] Achieve minimum 80% coverage for imgproto package (achieved 91.7%)
- [x] All tests pass with `go test ./internal/imgproto/...` (42 tests pass)
- [x] Run `go vet ./internal/imgproto/` with no errors

## Technical Notes

### Key Functions to Test
- `Detect() Protocol` - Environment-based protocol detection
- `Render() string` - Convert image.Image to protocol-specific string
- `quantizeColors(palette) []color.Color` - Color quantization
- Protocol-specific rendering (sixelRender, kittyRender, iTerm2Render)

### Test Data Requirements
- Small test image (16x16 pixels, 8 colors)
- Medium test image (64x64 pixels, 256 colors)
- Edge cases: 1x1, 1000x1000, single color, rainbow

### Environment Variable Test Cases
- `TERM=xterm-256color` + no Kitty/iTerm2 variables → Sixel
- `TERM=xterm-kitty` → Kitty
- `KITTY_WINDOW_ID=1` (any TERM) → Kitty
- `ITERM_SESSION_ID=xxx` (any TERM) → iTerm2
- `TERM=vt100` (no modern protocols) → ASCII fallback
- Multiple signals present → correct priority order

### Estimated Effort
- Unit tests: 3-4 days
- Auto-detection tests: 2-3 days
- Integration/fuzzing: 1 day
- Total: 5-8 days

## Related Specs
- Depends on: None
- Enables: "Extended Terminal Protocol Support" (WezTerm, Terminology, VT340)
- Related to: "Terminal Capability Detection Testing"

## Agent Output

2026-01-29T18:06:57Z

```
I'll implement a comprehensive test suite for the terminal image protocols. Let me start by reading the spec file and understanding the current codebase.
Let me fix the command and check the terminal package to understand the detection logic:
Now let me read the terminal package to understand how detection works:
Let me read the terminal.go to understand the detection mechanism:
Perfect! Now I understand the code structure. Let me create a comprehensive test suite. First, I'll plan the approach using the TodoWrite tool:
Now let me create the comprehensive test file:
Now let me mark the first todo as completed and run the tests:
Let me continue checking test output:
I see there's a test failure with the Kitty chunking test. Let me check what's happening and fix it. The issue is that the 512x512 gradient image might not be creating a large enough PNG to exceed 4096 bytes. Let me fix this test:
Now let me run the tests again:
Excellent! All tests pass. Now let me check coverage:
Great! 91.7% coverage is well above the 80% requirement. Now let me run go vet:
Perfect! No go vet errors. Let me update the todo list and then update the spec acceptance criteria:
Now let me update the spec acceptance criteria:
Now let me verify the tests one more time with full output, then commit:
Perfect! Now let me commit the changes:
I notice there are some other untracked files. Let me focus on committing only the imgproto test file and spec update:
Good, now let me commit with the proper message format:
Perfect! Let me verify the git status is clean and mark the final todo as completed:
Excellent! The git status is clean for the imgproto changes. Those untracked files are outside the scope of this spec. Let me mark the final todo as completed:
Perfect! Let me verify one final time that the implementation meets all acceptance criteria:
Excellent! Let me create a summary of what was implemented:

## Summary

I have successfully completed the comprehensive test suite for terminal image protocols in the moji project. Here's what was delivered:

### Test Coverage

**Created `internal/imgproto/imgproto_test.go`** with 42 comprehensive tests achieving **91.7% code coverage** (exceeding the 80% requirement):

#### Protocol Tests
- **TestProtocolString**: Validates protocol name string representations
- **TestParseProtocol**: Tests parsing of all protocol names (sixel, kitty, iterm2, ascii, auto) with case-insensitive matching
- **TestListProtocols**: Verifies the protocol list enumeration

#### Detection Tests (TestDetect)
- Tests all 8 environment variable combinations:
  - Kitty detection via KITTY_WINDOW_ID and TERM=xterm-kitty
  - iTerm2 detection via ITERM_SESSION_ID and TERM_PROGRAM=iTerm.app
  - Sixel detection via TERM
  - ASCII fallback for unsupported terminals
  - Correct priority ordering (Kitty > iTerm2 > Sixel > ASCII)

#### Rendering Tests
- **TestRenderSixel**: Tests Sixel graphics with solid colors, multi-color blocks, 1x1 images, and large scaled images
- **TestRenderKitty**: Tests Kitty protocol with proper command format, base64 encoding, and chunking validation
- **TestRenderITerm2**: Tests iTerm2 protocol with OSC 1337 sequence, inline parameters, and dimension preservation
- **TestRender**: Generic rendering function with all protocol variants

#### Color & Scaling Tests
- **TestQuantize**: Color quantization with varying palette sizes (16-256 colors)
- **TestClosestColor**: Color matching with exact and approximate nearest-neighbor distances
- **TestScaleImage**: Image scaling with aspect ratio preservation and edge cases
- **TestPNGEncoding**: PNG encoding validation

#### Protocol-Specific Tests
- **TestKittyChunking**: Validates proper chunking and termination for large images
- **TestSixelBands**: Tests Sixel 6-row band encoding and color definitions

#### Benchmarks
- BenchmarkQuantize, BenchmarkScaleImage, BenchmarkRenderSixel, BenchmarkRenderKitty, BenchmarkRenderITerm2

### Test Results
- ✅ **42 tests pass** with `go test ./internal/imgproto/...`
- ✅ **91.7% code coverage** (requirement: 80%)
- ✅ **No go vet errors**
- ✅ **All acceptance criteria checked off**
- ✅ **Committed** with proper reference to spec ID 2026-01-29-002-imgproto```
