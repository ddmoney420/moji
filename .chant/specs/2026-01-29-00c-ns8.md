---
type: code
status: completed
labels:
- feature
- dsl
target_files:
- internal/chain/parser.go
- internal/chain/pipeline.go
- internal/chain/parser_test.go
- internal/chain/pipeline_test.go
commits:
- b70bc7b
completed_at: 2026-01-29T20:56:23Z
---
# Enhance Native Chain Command with Pipeline DSL

## Problem Description

The current chain package uses struct-based options which is verbose. A pipeline DSL would allow expressive command chaining like `moji chain "banner 'Hello' | rainbow | wave | border-double"` for more intuitive effect composition.

## Solution Approach

1. Create `internal/chain/parser.go` with DSL parser
2. Support pipe-separated commands: `cmd1 | cmd2 | cmd3`
3. Support command arguments: `banner 'text'`, `gradient:fire`
4. Create `internal/chain/pipeline.go` for execution
5. Maintain backward compatibility with Options struct

## Acceptance Criteria

- [x] Create `parser.go` with DSL tokenizer and parser
- [x] `Parse(input string) (*Pipeline, error)` function
- [x] Support pipe `|` separator between commands
- [x] Support quoted strings for text arguments
- [x] Support colon notation for variants: `gradient:rainbow`
- [x] Support key=value arguments: `width=80`
- [x] Create `pipeline.go` with Pipeline executor
- [x] `Pipeline.Execute(input string) (string, error)`
- [x] `Pipeline.Steps() []Step` to inspect pipeline
- [x] Map DSL commands to existing functions (banner, gradient, effect, border, bubble)
- [x] Helpful error messages with position info
- [x] Unit tests with 90%+ coverage
- [x] go vet passes with no errors

## Technical Notes

- DSL Grammar:
  ```
  pipeline := step ('|' step)*
  step := command args?
  command := identifier (':' identifier)?
  args := (string | key'='value)*
  ```
- Example: `banner 'Hi' | gradient:fire | border:double padding=2`

## Agent Output

2026-01-29T20:56:25Z

```
I'll start by examining the current codebase to understand the chain package structure and then implement the pipeline DSL as specified.
Let me explore the current chain package structure:
Now let me check the project structure and look at how it's organized:
Good! Now let me check the spec file to understand all requirements:
Let me look at the effects, gradient, patterns, and speech packages to understand what functions I'll need to map:
Now let me check if there's a go.mod file to understand the project structure better:
Perfect! Now let me update my todo list and start implementing:
Now I'll create the parser.go file:
Now let's create the pipeline.go file with the executor:
Now let me update the todo and create comprehensive unit tests:
Now let's run the tests to see if everything works:
Let me remove the unused import:
I see several issues to fix:

1. The parser isn't handling key=value arguments correctly after variants
2. There's an issue with how tokens are being parsed when checking for identifiers with `=`
3. A nil pointer issue in the test

Let me fix the parser:
Let me read the current parseStep function exactly:
Now let me also fix the test cases that have issues:
Now let me fix the parse errors test:
Now let's run the tests again:
The issue is that numeric values are not being parsed as identifiers. Let me check the lexer to see how it handles numbers:
The issue is that the lexer doesn't recognize numeric values as identifiers. Let me fix that:
Now run the tests again:
Excellent! All tests are passing. Now let's check coverage and run go vet:
Perfect! 90.1% coverage. Now let's run go vet:
Great! No errors from go vet. Now let's run gofmt and check if code is properly formatted. First, let me check if there's a way to run go fmt:
Good, go fmt made some formatting changes. Let's verify all tests still pass:
Perfect! Now let's update the todo list and then update the spec file with checkmarks:
Now let's update the spec file with all acceptance criteria checked off:
Now let me add the model to the spec frontmatter:
Now let's commit the work with the proper message:
Perfect! Let's verify the git status is clean:
Excellent! Let's verify the implementation one more time by running the full test suite:
Perfect! Let me mark the final task as completed:
Perfect! Let me create a summary of what was implemented:

## Implementation Complete ✅

I have successfully implemented the **Pipeline DSL** for the moji chain package. Here's what was delivered:

### Files Created

1. **`internal/chain/parser.go`** - DSL Parser & Lexer
   - Full tokenizer supporting pipes, colons, equals, quoted strings, and identifiers
   - `Parse(input string)` function that converts DSL to Pipeline
   - Support for all required syntax:
     - Pipe separators: `|`
     - Quoted strings: `'text'` or `"text"`
     - Colon variants: `gradient:rainbow`
     - Key-value args: `width=80`
   - Helpful error messages with position information

2. **`internal/chain/pipeline.go`** - Pipeline Executor
   - `Pipeline.Execute(input string)` executes the DSL pipeline
   - `Pipeline.Steps()` returns inspectable pipeline steps
   - Command mapping: `effect`, `gradient`, `border`, `bubble`, `banner`
   - Helper functions for validation and discovery of available themes/styles

3. **`internal/chain/parser_test.go`** - 26 parser tests
   - Tests for lexer tokenization
   - Tests for DSL parsing with all variants
   - Tests for error handling with position info
   - Edge cases: whitespace, multiple args, complex pipelines

4. **`internal/chain/pipeline_test.go`** - 36 executor tests
   - Tests for all command types
   - Tests for argument handling
   - Tests for error cases (invalid themes, bad values)
   - Helper function tests

### Test Results
- **All 62 tests passing** ✅
- **90.1% code coverage** (exceeds 90% requirement) ✅
- **go vet: 0 errors** ✅
- **go fmt: formatted** ✅

### Acceptance Criteria
All 13 criteria met:
- [x] Create `parser.go` with DSL tokenizer and parser
- [x] `Parse(input string) (*Pipeline, error)` function
- [x] Support pipe `|` separator between commands
- [x] Support quoted strings for text arguments
- [x] Support colon notation for variants: `gradient:rainbow`
- [x] Support key=value arguments: `width=80`
- [x] Create `pipeline.go` with Pipeline executor
- [x] `Pipeline.Execute(input string) (string, error)`
- [x] `Pipeline.Steps() []Step` to inspect pipeline
- [x] Map DSL commands to existing functions
- [x] Helpful error messages with position info
- [x] Unit tests with 90%+ coverage
- [x] go vet passes with no errors

### Git Status
Clean working tree - all changes committed with message `chant(2026-01-29-00c-ns8)````
