---
type: code
status: ready
labels:
- testing
- image-processing
- algorithms
target_files:
- internal/dither/dither.go
- internal/dither/dither_test.go
---

# Add Test Coverage for Dithering Algorithms

## Problem Description

The `internal/dither/` package implements 9 different dithering algorithms for image ASCII conversion but has **zero test coverage**. Dithering directly impacts image quality when converting images to ASCII art.

The 620-line dither.go file implements:
- **Error Diffusion:** Floyd-Steinberg, Jarvis-Judice-Ninke, Stucki, Sierra, Atkinson
- **Ordered/Bayer:** Bayer 2x2, 4x4, 8x8 matrices
- **Threshold:** Simple ordered thresholding
- **Custom:** User-defined dithering patterns

Without tests:
- Algorithm correctness is unvalidated (potential output quality regression)
- Error diffusion correctness (pixel error propagation) unknown
- Bayer matrix calculations untested
- Different algorithm performance profiles unknown
- Edge cases (image boundaries, color quantization) uncovered

This impacts the core feature of converting images to ASCII art. Users relying on specific dithering algorithms have no guarantee of quality or correctness.

## Solution Approach

Create a comprehensive test suite covering:

1. **Floyd-Steinberg Tests**
   - Correct error propagation pattern
   - Boundary handling (edges, corners)
   - Color quantization accuracy
   - Output consistency across runs

2. **Error Diffusion Tests** (all variants)
   - Jarvis-Judice-Ninke matrix correctness
   - Stucki matrix correctness
   - Sierra variants correctness
   - Atkinson matrix correctness
   - Error normalization consistency

3. **Bayer Matrix Tests**
   - 2x2 matrix generation and application
   - 4x4 matrix generation and application
   - 8x8 matrix generation and application
   - Threshold calculation correctness

4. **Threshold Tests**
   - Simple binary thresholding
   - Ordered dithering vs. error diffusion output
   - Edge case thresholding

5. **Integration Tests**
   - Dither on actual grayscale images
   - Dither on color images with quantization
   - Round-trip consistency (image → dither → image → dither)
   - Performance benchmarking

6. **Edge Cases**
   - 1x1 pixel images
   - Very large images (1000x1000+)
   - All black/white images
   - High contrast images
   - Grayscale vs. color quantization

7. **Output Validation**
   - Error distribution across image
   - No out-of-bounds errors
   - Consistent color mapping
   - No NaN or infinity values

## Acceptance Criteria

- [ ] Create `internal/dither/dither_test.go` with unit tests
- [ ] Test Floyd-Steinberg algorithm correctness
- [ ] Test Jarvis-Judice-Ninke error diffusion
- [ ] Test Stucki error diffusion
- [ ] Test Sierra error diffusion variants
- [ ] Test Atkinson error diffusion
- [ ] Test Bayer 2x2, 4x4, 8x8 matrices
- [ ] Test threshold algorithm
- [ ] Test error propagation patterns for correctness
- [ ] Test boundary handling (edges, corners, wraparound)
- [ ] Test color quantization with dithering
- [ ] Test with various image sizes (1x1, 2x2, 100x100, 1000x1000)
- [ ] Test with extreme images (all black, all white, high contrast)
- [ ] Test output pixel value ranges (no NaN, no overflow)
- [ ] Test consistency across multiple runs with same input
- [ ] Achieve minimum 80% coverage for dither package
- [ ] All tests pass with `go test ./internal/dither/...`
- [ ] Run `go vet ./internal/dither/` with no errors
- [ ] (Optional) Add benchmark tests for algorithm performance

## Technical Notes

### Key Functions to Test
- `Floyd(img image.Image, palette color.Palette) image.Image` - Floyd-Steinberg dithering
- `Bayer(img image.Image, palette color.Palette, level int) image.Image` - Bayer matrix dithering
- `Threshold(img image.Image, t uint8) image.Image` - Simple thresholding
- `Atkinson(img image.Image, palette color.Palette) image.Image` - Atkinson dithering
- Individual matrix functions for error diffusion patterns

### Floyd-Steinberg Error Distribution
```
       X   7/16
3/16  5/16  1/16
```
Test that errors are propagated to neighboring pixels correctly.

### Bayer Matrices
- 2x2: 4 levels of quantization
- 4x4: 16 levels of quantization
- 8x8: 64 levels of quantization

Each matrix must be tested for correct threshold application.

### Test Image Data
Create test images:
- Grayscale gradient (256 steps from black to white)
- Color gradient (rainbow spectrum)
- High contrast image (black and white areas)
- Checkerboard pattern (alternating pixels)
- Solid color images (all black, all white, all gray)
- Natural image (photograph, complex details)

### Output Validation Criteria
1. **Pixel Value Ranges:** All output pixels in [0, 255]
2. **No NaN/Infinity:** Check for floating-point errors
3. **Color Mapping:** Output colors match palette
4. **Consistency:** Same input always produces same output
5. **Boundary Safety:** No out-of-bounds array access
6. **Performance:** Reasonable speed for 1000x1000 images

### Estimated Effort
- Error diffusion algorithm tests: 2-3 days
- Bayer matrix tests: 1-2 days
- Threshold tests: 0.5 day
- Integration/validation tests: 1-2 days
- Output verification: 0.5-1 day
- Total: 5-7 days

## Related Specs
- Depends on: None
- Enables: "Parallel Image Processing" (validates dithering before parallelization)
- Related to: "Image Protocol Testing"
