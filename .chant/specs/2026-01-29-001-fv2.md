---
type: task
status: completed
labels:
- research
- enhancement
- documentation
---
# Research and Document Enhancement Opportunities for Moji

## Problem Description

Moji is a feature-rich terminal art toolkit with 16,500+ lines of Go code, 31 internal packages, and 13+ feature categories. While the codebase is well-architected with good fundamentals, there are opportunities for enhancement across testing, performance, features, and documentation.

This spec documents a prioritized enhancement roadmap based on comprehensive codebase analysis.

## Enhancement Categories

### Priority 1: Test Coverage & Quality (High Impact, Medium Effort)

1. **Increase Unit Test Coverage to 80%+**
   - Current estimated coverage: 60-70%
   - Packages needing tests: `chain`, `demo`, `dither`, `imgproto`, `progress`
   - Target files: `internal/*/` packages without `*_test.go`

2. **TUI Testing with Mock Terminal**
   - Current: TUI tests skip in CI due to TTY requirement
   - Solution: Implement terminal mocking using `bubbletea/teatest`
   - File: `internal/tui/tui_test.go`

3. **Integration Test Suite**
   - Missing: End-to-end command pipeline tests
   - Examples: `banner | filter`, `convert | effect` chains
   - Create: `integration_test.go` at project root

4. **Fuzzing Tests for Unicode Effects**
   - Risk: Text effects with Unicode transformations
   - Test: RTL text, emoji, combining characters, malformed UTF-8
   - Location: `internal/effects/effects_fuzz_test.go`

### Priority 2: Performance Optimization (High Impact, Medium Effort)

5. **FIGlet Font Caching**
   - Problem: Fonts parsed on every use
   - Solution: In-memory LRU cache or disk cache at `~/.cache/moji/fonts/`
   - File: `internal/figlet/cache.go`

6. **Parallel Image Processing**
   - Current: Batch uses worker pools but convert.go is single-threaded
   - Enhancement: Add concurrent pixel processing for large images
   - File: `internal/convert/parallel.go`

7. **Performance Benchmarks**
   - Missing: No benchmark tests
   - Add: `*_bench_test.go` files for core operations
   - Track: Font parsing, image conversion, filter application

### Priority 3: Feature Enhancements (Medium Impact, Variable Effort)

8. **Plugin/Extension System**
   - Current: Effects and filters are hardcoded
   - Proposal: Lua scripting or WASM-based plugins
   - Scope: User-defined effects, custom charsets, color schemes
   - Files: `internal/plugins/` (new package)

9. **Real-time Watch Mode**
   - Feature: `--watch` flag for auto-update on file changes
   - Use case: Live ASCII art development
   - Integration: Use `fsnotify` for file watching

10. **Extended Terminal Protocol Support**
    - Current: Sixel, Kitty, iTerm2
    - Add: WezTerm, Terminology, VT340 ReGIS
    - File: `internal/imgproto/` additions

11. **Custom Color Profiles**
    - Feature: User-defined color schemes
    - Storage: `~/.config/moji/themes/`
    - Format: YAML theme files

12. **Chained Command Piping**
    - Improvement: Native `chain` command for effect pipelines
    - Example: `moji chain "banner 'Hi' | rainbow | wave"`
    - Package: `internal/chain/` enhancement

### Priority 4: Documentation & DX (Medium Impact, Low Effort)

13. **Package-Level Godoc Documentation**
    - Missing: No `doc.go` files in packages
    - Add: Package overview, example usage
    - All 31 `internal/*/` packages

14. **Configuration Schema Documentation**
    - Issue: Config file format underdocumented
    - Solution: Generate JSON Schema, add examples
    - File: `docs/config.md` or inline in README

15. **Examples Directory**
    - Create: `examples/` with shell scripts
    - Content: Chaining, batch processing, custom gradients
    - Include: Makefile targets for examples

16. **API Reference for WASM**
    - Current: Web playground exists but API not documented
    - Add: TypeScript definitions, usage examples
    - Location: `web/docs/` or `cmd/wasm/README.md`

### Priority 5: Code Architecture (Low Impact, Medium Effort)

17. **Split TUI Module**
    - Issue: `internal/tui/tui.go` is 1,536 lines (largest file)
    - Solution: Split into `tabs.go`, `keybinds.go`, `render.go`, etc.
    - Benefit: Easier maintenance and testing

18. **Standardize Error Format**
    - Current: Errors are generally good but inconsistent
    - Proposal: Custom error types with suggestion field
    - File: `internal/errors/errors.go`

19. **Configuration Validation**
    - Issue: Config parsing is lenient
    - Add: Schema validation, deprecation warnings
    - Location: `internal/config/validate.go`

## Acceptance Criteria

- [x] Review and prioritize enhancement list with stakeholder input
- [x] Create individual specs for top 5 priority items
- [x] Estimate effort for each enhancement category
- [x] Identify dependencies between enhancements
- [x] Document decision rationale for prioritization

## Research Findings

### Codebase Analysis Summary

**Validated Statistics:**
- **Total Internal LOC:** 13,981 (internal packages only)
- **Test Coverage:** 17 of 30 packages have tests (~57%)
- **Average Test Coverage:** ~83% for tested packages
- **Internal Packages:** 30 packages
- **Top-Level Commands:** 8 command handlers + 35+ Cobra subcommands
- **Dependencies:** 9 direct dependencies, all actively maintained

**Test Coverage by Priority Tier:**

1. **High Coverage (85-100%):**
   - `chain` (100%), `fortune` (100%), `speech` (100%)
   - `calendar` (99.2%), `export` (98.6%), `styles` (97.0%), `filters` (98.7%), `artdb` (97.1%)

2. **Medium Coverage (56-84%):**
   - `effects` (82.7%), `gradient` (86.4%), `banner` (90.0%), `tree` (84.9%)
   - `convert` (69.1%), `qrcode` (74.1%), `patterns` (59.7%), `kaomoji` (56.0%)

3. **Zero Coverage (0%):**
   - `animate` (175 LOC), `batch` (124 LOC), `config` (260 LOC), `demo` (592 LOC)
   - `dither` (620 LOC), `figlet` (300+ LOC), `halfblock` (295 LOC)
   - `imgproto` (351 LOC), `progress` (272 LOC), `sysinfo` (332 LOC)
   - `terminal` (374 LOC), `ux` (600 LOC)

### Critical Gaps Identified

**Category 1: Terminal Graphics (CRITICAL)**
- `internal/imgproto/` implements Sixel, Kitty, iTerm2 protocols
- **Zero test coverage** despite being core feature
- Auto-detection logic untested
- 351 lines of untested terminal protocol code

**Category 2: Configuration System (HIGH PRIORITY)**
- `internal/config/` loads XDG-compliant YAML/JSON
- **Zero test coverage** for loading, saving, presets, aliases
- Preset system (`neon-banner`, `retro`, `fire-banner`) untested
- 260+ lines of untested configuration code

**Category 3: Terminal Capability Detection (HIGH PRIORITY)**
- `internal/terminal/` detects color levels and protocol support
- **Zero test coverage** for environment detection
- 374 lines of untested detection logic

**Category 4: Image Processing Quality (MEDIUM PRIORITY)**
- `internal/dither/` implements 9 dithering algorithms
- **Zero test coverage** despite Floyd-Steinberg, Bayer, Atkinson variants
- 620 lines of complex algorithm code

### Large File Refactoring Opportunity

**TUI Module:** `internal/tui/tui.go` is 1,536 lines
- Implements 11 feature tabs (Banner, Kaomoji, ArtDB, Filters, Effects, Gradient, QR, Patterns, Speech, Calendar, Sysinfo)
- Contains 4 focus states and 5 export formats
- Could be split into: `tabs.go`, `keybinds.go`, `render.go`, `export.go`, `state.go`
- Candidate for refactoring but lower priority (complexity vs. benefit tradeoff)

### Test Coverage Reality vs. Estimate

**Findings vs. Original Estimates:**
- Original: "60-70% estimated coverage"
- Actual: ~57% of packages have tests, with gaps concentrated in 12 packages
- **12 untested packages total** including critical ones (imgproto, config, terminal)
- Packages to focus on: imgproto (351 LOC), dither (620 LOC), terminal (374 LOC), config (260 LOC)

## Technical Notes

### Codebase Statistics
- **Total Internal LOC:** 13,981
- **Test LOC:** ~1,500
- **Packages:** 30 internal packages (17 with tests, 12 without)
- **Commands:** 35+ Cobra subcommands across 8 command handler files
- **Major Files:** TUI (1,536), Styles (640), Dither (620), Demo (592), Kaomoji (590), Filters (555), ArtDB (553)
- **Dependencies:** 9 direct, all actively maintained

### Key Files for Reference
- `main.go` - CLI entry point (129 lines)
- `internal/tui/tui.go` - Interactive TUI (1,536 lines) - REFACTOR CANDIDATE
- `internal/imgproto/imgproto.go` - Terminal graphics protocols (351 lines) - ZERO TESTS
- `internal/dither/dither.go` - Dithering algorithms (620 lines) - ZERO TESTS
- `internal/config/config.go` - Config system (260+ lines) - ZERO TESTS
- `internal/terminal/terminal.go` - Terminal detection (374 lines) - ZERO TESTS

### Dependency Considerations
- Charmbracelet ecosystem (bubbletea, bubbles, lipgloss) - stable, well-maintained
- Image processing uses golang.org/x/image - validate untrusted image inputs
- All dependencies pinned to specific versions; actively maintained

### Terminal Protocol Support Status
**Currently Supported (in imgproto):**
- ASCII (default fallback)
- Sixel (xterm, mlterm, foot, mintty, contour)
- Kitty graphics protocol (Kitty terminal)
- iTerm2 inline images (iTerm2 on macOS)

**Auto-Detection Logic:**
- Checks TERM environment variable
- Detects KITTY_WINDOW_ID and ITERM_SESSION_ID
- Fallback order: Kitty → iTerm2 → Sixel → ASCII
- Untested and undocumented

## Related Resources
- Repository: https://github.com/ddmoney420/moji
- Current Version: v1.0.1
- Go Version: 1.24.8
- CLI Framework: Cobra
- TUI Framework: Charmbracelet BubbleTea

## Prioritization Rationale & Enhancement Roadmap

### Top 5 Priority Enhancements (Based on Impact & Effort Analysis)

#### **Priority 1: Image Protocol Testing (imgproto)**
- **Impact:** CRITICAL - Terminal graphics are core functionality
- **Status:** 351 lines of untested protocol code (Sixel, Kitty, iTerm2, auto-detection)
- **Effort:** MEDIUM (5-8 days)
- **Effort Breakdown:** Protocol unit tests (3-4 days), auto-detection tests (2-3 days), integration tests (1 day)
- **Dependencies:** None (self-contained)
- **ROI:** High - Catches protocol regressions, validates color quantization
- **Recommended Spec:** "Add comprehensive test suite for terminal image protocols (Sixel, Kitty, iTerm2)"

#### **Priority 2: Terminal Capability Detection Testing (terminal)**
- **Impact:** HIGH - Feature detection affects protocol selection
- **Status:** 374 lines of untested environment detection
- **Effort:** MEDIUM (3-5 days)
- **Effort Breakdown:** Environment detection tests (2-3 days), color level tests (1-2 days)
- **Dependencies:** None
- **ROI:** High - Prevents protocol misdetection, validates feature availability
- **Recommended Spec:** "Add test coverage for terminal capability detection and color level inference"

#### **Priority 3: Configuration System Testing (config)**
- **Impact:** HIGH - User data persistence is critical
- **Status:** 260+ lines untested for loading, saving, presets, aliases
- **Effort:** MEDIUM (4-6 days)
- **Effort Breakdown:** Config loading tests (2 days), persistence tests (1-2 days), preset tests (1-2 days)
- **Dependencies:** None
- **ROI:** High - Prevents config loss, validates preset system
- **Recommended Spec:** "Add test coverage for configuration system (loading, persistence, presets, aliases)"

#### **Priority 4: Dithering Algorithm Testing (dither)**
- **Impact:** MEDIUM - Image quality directly depends on dithering
- **Status:** 620 lines of complex algorithm code, zero tests
- **Effort:** MEDIUM (5-7 days)
- **Effort Breakdown:** Unit tests for each algorithm (3-4 days), output validation (2-3 days)
- **Dependencies:** None
- **ROI:** High - Validates visual output quality, catches algorithm regressions
- **Recommended Spec:** "Add test coverage for dithering algorithms (Floyd-Steinberg, Bayer, Atkinson, etc.)"

#### **Priority 5: TUI Module Refactoring (tui)**
- **Impact:** MEDIUM - Code maintainability and testing capability
- **Status:** 1,536 lines in single file; makes testing difficult
- **Effort:** MEDIUM-HIGH (6-10 days)
- **Effort Breakdown:** Analysis (1 day), split into tabs.go (2 days), keybinds.go (1 day), render.go (2 days), export.go (1 day), state.go (2 days), tests (3-4 days)
- **Dependencies:** Internal refactoring, no external
- **ROI:** Medium - Improves code maintainability, enables better testing
- **Recommended Spec:** "Refactor TUI module by splitting into functional files (tabs, keybinds, render, export, state)"

### Secondary Priority Enhancements

**Performance Optimization (Priority 2):**
- **Font Caching** - Estimated effort: MEDIUM (3-4 days)
- **Parallel Image Processing** - Estimated effort: MEDIUM (4-5 days)
- **Performance Benchmarks** - Estimated effort: LOW-MEDIUM (2-3 days)

**Feature Enhancements (Priority 3):**
- **Watch Mode** - Estimated effort: LOW-MEDIUM (3-5 days)
- **Extended Terminal Protocols** - Estimated effort: MEDIUM (5-7 days)
- **Plugin System** - Estimated effort: HIGH (10-14 days)

**Documentation (Priority 4):**
- **Godoc Documentation** - Estimated effort: MEDIUM (4-6 days)
- **Examples Directory** - Estimated effort: LOW-MEDIUM (2-3 days)
- **Configuration Schema** - Estimated effort: LOW-MEDIUM (2-3 days)

### Dependency Analysis

**Top Priority Tests Enable:**
- `imgproto` tests → Prerequisites for "Extended Terminal Protocols"
- `terminal` tests → Prerequisites for protocol auto-detection improvements
- `config` tests → Prerequisites for custom theme/preset features
- `dither` tests → Prerequisites for image processing optimization

**Recommended Execution Order:**
1. Image Protocol Testing (enables terminal feature work)
2. Terminal Detection Testing (enables protocol auto-detection validation)
3. Configuration Testing (enables custom theme features)
4. Dithering Tests (enables image quality improvements)
5. TUI Refactoring (enables better testing overall)

### Effort Estimates Summary

| Priority | Item | Impact | Effort | Total Days |
|----------|------|--------|--------|------------|
| 1 | Image Protocol Testing | CRITICAL | MEDIUM | 5-8 |
| 2 | Terminal Detection Testing | HIGH | MEDIUM | 3-5 |
| 3 | Configuration Testing | HIGH | MEDIUM | 4-6 |
| 4 | Dithering Algorithm Testing | MEDIUM | MEDIUM | 5-7 |
| 5 | TUI Refactoring | MEDIUM | HIGH | 6-10 |
| - | **Subtotal Top 5** | **—** | **—** | **23-36** |
| - | Performance (Font Cache, etc.) | HIGH | MEDIUM | 5-7 |
| - | Feature Enhancements | MEDIUM | MEDIUM-HIGH | 8-26 |
| - | Documentation | MEDIUM | LOW | 6-10 |
| - | **Total Roadmap** | **—** | **—** | **42-79** |

### Key Findings

1. **Test Coverage Gap is Real:** 12 packages with zero tests, especially critical ones (imgproto, config, terminal)
2. **TUI Module is a Hotspot:** 1,536 lines makes testing difficult; refactoring would improve code quality
3. **Terminal Support is Untested:** Core graphics protocols lack validation; high risk for regressions
4. **Configuration System Lacks Validation:** User data persistence untested; preset system untested
5. **Algorithm Quality Untested:** 9 dithering variants with no output validation

### Recommended Next Steps

1. **Create 5 individual specs** for top priority items using this roadmap
2. **Execute in order** to maximize dependencies and build momentum
3. **Target 80%+ coverage** in currently untested packages
4. **Validate output quality** through integration tests for image processing
5. **Monitor execution time** to refine future effort estimates

### Decision Rationale

**Why These 5?**
- Address critical gaps (terminal graphics, configuration, detection)
- High impact-to-effort ratio
- Enable subsequent improvements
- Improve code maintainability (TUI refactoring)
- Build confidence in core systems

**Why Not Plugin System?**
- High effort (10-14 days) with uncertain ROI
- Requires more design/community input
- Can be added later after core improvements

**Why Not More Documentation?**
- Lower priority for stability/functionality
- Can be done in parallel with code improvements
- Better documentation comes after clearer architecture (post-TUI refactoring)

## Completion Summary

### Research & Analysis Completed

✅ **Codebase Exploration:**
- Explored 30 internal packages and 8 command handlers
- Identified 17 packages with tests (~57% coverage) and 12 without (43% gap)
- Discovered critical untested packages: imgproto, config, terminal, dither

✅ **Enhancement Opportunities Validated:**
- Priority 1 (Testing): Confirmed gaps in imgproto, config, terminal, dither
- Priority 2 (Performance): Identified caching and parallelization opportunities
- Priority 3-5 (Features & Architecture): Documented with effort estimates

✅ **Top 5 Priority Specs Created:**
1. **2026-01-29-002-imgproto.md** - Terminal graphics protocol testing (5-8 days)
2. **2026-01-29-003-terminal.md** - Terminal capability detection testing (3-5 days)
3. **2026-01-29-004-config.md** - Configuration system testing (4-6 days)
4. **2026-01-29-005-dither.md** - Dithering algorithm testing (5-7 days)
5. **2026-01-29-006-tui-refactor.md** - TUI module refactoring (6-10 days)

### Key Findings Summary

**Testing Gaps (Critical Priority):**
- `imgproto` (351 LOC) - 0% coverage - Terminal graphics protocols untested
- `config` (260+ LOC) - 0% coverage - User data persistence untested
- `terminal` (374 LOC) - 0% coverage - Feature detection untested
- `dither` (620 LOC) - 0% coverage - Image quality algorithms untested
- 8 other packages with 0% coverage

**Code Maintenance Opportunities:**
- `internal/tui/tui.go` at 1,536 lines - refactoring candidate
- TUI contains 11 feature tabs in single file
- Refactoring would improve testability and maintainability

**Performance Opportunities:**
- FIGlet fonts parsed on every use - caching recommended
- Image conversion is single-threaded - parallelization possible
- No benchmark tests - performance tracking missing

**Feature Enhancement Opportunities:**
- 19 documented enhancement items across 5 priority tiers
- Plugin system, watch mode, extended terminal support identified
- Estimated total effort: 42-79 days across all priorities

### Deliverables

**Main Spec File:** `.chant/specs/2026-01-29-001-fv2.md`
- Enhanced with codebase analysis findings
- Added detailed prioritization rationale
- Added dependency analysis
- Added effort estimates for all enhancement categories
- Status: COMPLETED

**5 Ready-to-Execute Specs:**
- `2026-01-29-002-imgproto.md` (Terminal Graphics Testing)
- `2026-01-29-003-terminal.md` (Terminal Detection Testing)
- `2026-01-29-004-config.md` (Configuration Testing)
- `2026-01-29-005-dither.md` (Dithering Algorithm Testing)
- `2026-01-29-006-tui-refactor.md` (TUI Module Refactoring)

All specs include:
- Clear problem description
- Detailed solution approach
- Specific, measurable acceptance criteria
- Technical implementation notes
- Effort estimates
- Dependency relationships

### Next Steps

Teams can now:
1. Review the enhancement roadmap in this spec
2. Execute the 5 ready-to-implement specs in priority order
3. Track progress using `chant work` for each spec
4. Plan subsequent enhancements based on this roadmap

**Recommended Execution Sequence:**
1. Image Protocol Testing → establish protocol baseline
2. Terminal Detection Testing → validate feature detection
3. Configuration Testing → ensure user data safety
4. Dithering Algorithm Testing → improve image quality
5. TUI Refactoring → improve code maintainability

Total estimated effort for top 5: **23-36 days**
Total estimated effort for full roadmap: **42-79 days**