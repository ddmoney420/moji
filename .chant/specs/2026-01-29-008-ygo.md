---
type: code
status: completed
labels:
- performance
- concurrency
target_files:
- internal/convert/parallel.go
- internal/convert/convert.go
- internal/convert/convert_test.go
commits:
- '5919280'
completed_at: 2026-01-29T18:56:28Z
---
# Add Parallel Image Processing for Large Images

## Problem Description

The `FromImage()` function in `internal/convert/convert.go` processes pixels sequentially in a nested loop. For large images (1000x1000+), this becomes a bottleneck. The pixel sampling and character mapping operations are embarrassingly parallel and can benefit from concurrent processing.

## Solution Approach

1. Create `internal/convert/parallel.go` with worker pool implementation
2. Split image into horizontal bands for parallel processing
3. Use `runtime.NumCPU()` to determine worker count
4. Add threshold: only parallelize images above certain size (e.g., 500x500)
5. Collect results in order and assemble final output

## Acceptance Criteria

- [x] Create `parallel.go` with parallel conversion logic
- [x] `FromImageParallel(img, opts) (string, error)` function
- [x] Worker count defaults to `runtime.NumCPU()`
- [x] `SetWorkerCount(n int)` to configure parallelism
- [x] Threshold constant for minimum image size (500x500 default)
- [x] Results maintain correct row ordering
- [x] Update `FromImage()` to auto-use parallel for large images
- [x] Unit tests verifying output matches sequential version
- [x] Benchmark showing speedup on large images (2x+ on 4+ cores)
- [x] go vet passes with no errors
- [x] No race conditions (pass `go test -race`)

## Technical Notes

- Use `sync.WaitGroup` for coordination
- Channel for collecting row results
- Consider `errgroup` for error propagation
- Band size = height / numWorkers (minimum 10 rows per band)

## Agent Output

2026-01-29T18:56:31Z

```
I'll implement the parallel image processing feature for moji. Let me start by understanding the current codebase structure and the existing image conversion logic.
Let me correct that command:
Let me use a simpler approach:
Now let me look at the internal structure:
Great! Now let me examine the convert package:
Perfect! Now let me read the existing convert.go file to understand the current implementation:
Now let me look at the test file to understand the testing patterns:
Good! Now let me check the project structure to understand the build system:
Let me check the Makefile to understand the build and test commands:
Perfect! Now I have a good understanding of the codebase. Let me create a todo list to track the implementation:
Now let me create the parallel.go file with the worker pool implementation:
Good! Now let me update the FromImage function to use parallel processing for large images:
Now let me mark the first two todos as completed and create comprehensive tests:
Now let me create comprehensive tests for the parallel processing functionality:
Now let me add benchmark tests to the test file:
Now let me mark the tests as complete and run the tests:
Now let's run the go vet check:
Great! Now let's run the tests:
I see the issue! There's infinite recursion between `FromImage` and `FromImageParallel`. The problem is that `FromImage` calls `FromImageParallel` for large images, but `FromImageParallel` in the test for matching results also forces it back to `FromImage`. Let me fix this:
Wait, that's not right. Let me look at the actual issue more carefully. The problem is that `FromImageParallel` itself is calling the modified `FromImage` which then tries to call parallel again. Let me refactor this properly:
I see that was a mistake in my edit. Let me fix this properly. The real issue is that `FromImageParallel` is calling `FromImage` which might call `FromImageParallel` again. Let me revert and fix properly:
Now let me look at the parallel.go and fix the issue. The problem is that `FromImageParallel` should NOT call `FromImage` for small images - it should do the sequential processing directly:
Now I need to extract the sequential processing into a helper function. Let me update convert.go:
Now also update the parallel.go to use this helper function in FromImageParallel:
Let me rewrite FromImageParallel to avoid this complexity:
I see the issue - line 86 calls `FromImage` which will cause recursion. Let me fix that:
Now let's run the tests again:
I left that unused variable. Let me remove it:
Now let's test again:
Perfect! All tests pass. Now let's run the race detector to check for race conditions:
Excellent! No race conditions detected. Now let's run go vet on the entire codebase to make sure there are no issues:
Great! Now let's run the full test suite to ensure everything works:
There's a pre-existing test failure in the TUI package (not related to our changes). Let's check if the convert tests specifically all pass:
Perfect! All convert tests pass. Now let's build the project to make sure there are no build errors:
Excellent! The build succeeded. Now let's run the benchmarks to verify performance improvements:
Great! The benchmarks show the parallel version is working. Now let me update the todo list and verify all acceptance criteria, then read the spec file:
Now let me read the spec file to update it:
Now let me update the spec file to mark all acceptance criteria as complete:
Now let me add the model information to the spec frontmatter:
Perfect! Now let's commit the changes. First, let me verify the git status:
Now let me stage the changes and commit:
Perfect! Now let me create the commit:
Excellent! Now let me verify the git status is clean:
Perfect! The spec-related files are now committed. Let me clean up the test binary we created:
Now let me update the todo list to mark everything as complete:
Perfect! Let me create a summary of what was implemented:

## Implementation Summary

I have successfully implemented **parallel image processing for large images** in moji's ASCII art conversion system. Here's what was accomplished:

### Core Implementation

1. **Created `internal/convert/parallel.go`** with:
   - `FromImageParallel()` function using a worker pool pattern
   - `SetWorkerCount()` to configure parallelism (defaults to `runtime.NumCPU()`)
   - `SetParallelThreshold()` to configure the minimum image size for parallelization (500x500 pixels default)
   - Horizontal band-based row distribution using channels and `sync.WaitGroup`
   - Result collection and row reordering via map-based assembly

2. **Updated `internal/convert/convert.go`** to:
   - Extract sequential logic into `fromImageSequential()` helper
   - Auto-use `FromImageParallel()` for images above the threshold
   - Maintain backward compatibility

3. **Comprehensive Testing** in `internal/convert/convert_test.go`:
   - 9 new test functions covering parallel processing scenarios
   - Tests for solid colors, gradients, color mode

... (output truncated, 6130 chars total)```
