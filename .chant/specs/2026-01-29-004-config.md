---
type: code
status: ready
labels:
- testing
- configuration
- high-priority
target_files:
- internal/config/config.go
- internal/config/config_test.go
---

# Add Test Coverage for Configuration System

## Problem Description

The `internal/config/` package manages user configuration (YAML/JSON files, presets, aliases) but has **zero test coverage**. This is critical because configuration affects:

1. **Data Persistence:** User settings, preferences, aliases
2. **Preset System:** Built-in presets (neon-banner, retro, fire-banner) are untested
3. **Alias Resolution:** Custom command shortcuts have no validation
4. **XDG Compliance:** Configuration paths and defaults are untested

The 260+ line config.go file handles:
- Loading from `$XDG_CONFIG_HOME/moji/config.yaml` (or `~/.config/moji/config.yaml`)
- Legacy support for `~/.mojirc` in YAML or JSON
- Default configuration fallback
- Preset system with 3+ built-in presets
- User-defined aliases
- Category-specific defaults (banner fonts, convert charset, gradient theme, etc.)

Without tests:
- Configuration corruption could go undetected
- Preset system might fail silently
- Alias resolution could break
- XDG path handling is untested
- Legacy format migration is untested

## Solution Approach

Create a comprehensive test suite covering:

1. **Config Loading Tests**
   - Load from primary XDG path
   - Load from legacy ~/.mojirc path
   - Load with missing file (use defaults)
   - Load from both YAML and JSON formats

2. **Config Parsing Tests**
   - Valid YAML/JSON parsing
   - Invalid format handling
   - Partial config merging with defaults
   - Malformed file handling

3. **Preset System Tests**
   - Load built-in presets (neon-banner, retro, fire-banner)
   - Validate preset structure
   - Apply preset to configuration
   - Custom preset support

4. **Alias Resolution Tests**
   - Resolve aliases to full commands
   - Handle undefined aliases (should error)
   - Alias collision detection
   - Reserved name conflicts

5. **Default Values Tests**
   - Verify all category defaults (Banner, Convert, Gradient, etc.)
   - Merge user config with defaults correctly
   - Override specific fields while preserving others

6. **File Persistence Tests**
   - Save configuration to file
   - Round-trip load/save consistency
   - File permissions/ownership
   - Backup/rollback behavior

7. **Edge Cases**
   - Empty config file
   - Config file with only comments
   - Symlinks and permission issues
   - XDG_CONFIG_HOME override

## Acceptance Criteria

- [ ] Create `internal/config/config_test.go` with unit tests
- [ ] Test `Load()` function with XDG and legacy paths
- [ ] Test YAML and JSON format parsing
- [ ] Test default configuration fallback
- [ ] Test preset system for 3+ built-in presets
- [ ] Test custom preset loading and application
- [ ] Test alias resolution logic
- [ ] Test configuration merging (user + defaults)
- [ ] Test category-specific defaults (Banner, Convert, Gradient, etc.)
- [ ] Test `Save()` function for persistence
- [ ] Test round-trip consistency (load → modify → save → load)
- [ ] Test XDG_CONFIG_HOME environment override
- [ ] Test legacy ~/.mojirc path fallback
- [ ] Test error handling for invalid/corrupted files
- [ ] Achieve minimum 80% coverage for config package
- [ ] All tests pass with `go test ./internal/config/...`
- [ ] Run `go vet ./internal/config/` with no errors

## Technical Notes

### Key Functions to Test
- `Load() *Config` - Load configuration from disk
- `LoadFromPath(path string) *Config` - Load from specific path
- `Save() error` - Persist configuration to file
- `ResolveAlias(alias string) string` - Expand alias to full command
- `GetPreset(name string) Preset` - Retrieve preset by name
- `ApplyPreset(p Preset) error` - Apply preset to config
- `MergeWithDefaults() *Config` - Merge user config with defaults

### Configuration Structure
```yaml
# Category defaults
defaults:
  banner:
    font: "standard"
    style: "bold"
    border: "double"
  convert:
    width: 80
    charset: "standard"
    dither: "floyd"
  gradient:
    theme: "neon"
    mode: "linear"
  # ... more categories

# Built-in presets
presets:
  neon-banner:
    name: "Neon Banner"
    command: "banner"
    args:
      gradient: "neon"
      border: "double"
  # ... more presets

# User aliases
aliases:
  art-demo: "art mountains"
  ascii-cat: "art cat"

# Art/Font/Cowfile paths
artPaths:
  - "~/.config/moji/art"
fontPaths:
  - "~/.config/moji/fonts"
cowfilePaths:
  - "~/.config/moji/cowfiles"
```

### Test Data Requirements
- Valid YAML config file with all sections
- Valid JSON config file
- Minimal config (just presets)
- Config with only aliases
- Config with only defaults
- Malformed files (invalid YAML, incomplete JSON)
- Empty files
- Files with BOM markers
- Symlinks to config files
- Permission-restricted files

### Test Scenarios
1. Fresh install (no config file, use in-memory defaults)
2. Upgraded user (legacy ~/.mojirc, needs migration)
3. Custom presets alongside built-ins
4. Alias shadowing (user alias overrides built-in command)
5. XDG_CONFIG_HOME override (non-standard config location)
6. Config in multiple formats (prefer YAML, fall back to JSON)

### Estimated Effort
- Load/parse tests: 2 days
- Preset system tests: 1-2 days
- Alias tests: 1 day
- Persistence tests: 1 day
- Edge cases: 1 day
- Total: 4-6 days

## Related Specs
- Depends on: None
- Enables: "Custom Theme/Preset Features"
- Related to: "Terminal Capability Detection Testing"
