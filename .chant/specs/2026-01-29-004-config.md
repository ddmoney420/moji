---
type: code
status: completed
labels:
- testing
- configuration
- high-priority
target_files:
- internal/config/config.go
- internal/config/config_test.go
commits:
- eb30b7a
completed_at: 2026-01-29T18:02:12Z
---
# Add Test Coverage for Configuration System

## Problem Description

The `internal/config/` package manages user configuration (YAML/JSON files, presets, aliases) but has **zero test coverage**. This is critical because configuration affects:

1. **Data Persistence:** User settings, preferences, aliases
2. **Preset System:** Built-in presets (neon-banner, retro, fire-banner) are untested
3. **Alias Resolution:** Custom command shortcuts have no validation
4. **XDG Compliance:** Configuration paths and defaults are untested

The 260+ line config.go file handles:
- Loading from `$XDG_CONFIG_HOME/moji/config.yaml` (or `~/.config/moji/config.yaml`)
- Legacy support for `~/.mojirc` in YAML or JSON
- Default configuration fallback
- Preset system with 3+ built-in presets
- User-defined aliases
- Category-specific defaults (banner fonts, convert charset, gradient theme, etc.)

Without tests:
- Configuration corruption could go undetected
- Preset system might fail silently
- Alias resolution could break
- XDG path handling is untested
- Legacy format migration is untested

## Solution Approach

Create a comprehensive test suite covering:

1. **Config Loading Tests**
   - Load from primary XDG path
   - Load from legacy ~/.mojirc path
   - Load with missing file (use defaults)
   - Load from both YAML and JSON formats

2. **Config Parsing Tests**
   - Valid YAML/JSON parsing
   - Invalid format handling
   - Partial config merging with defaults
   - Malformed file handling

3. **Preset System Tests**
   - Load built-in presets (neon-banner, retro, fire-banner)
   - Validate preset structure
   - Apply preset to configuration
   - Custom preset support

4. **Alias Resolution Tests**
   - Resolve aliases to full commands
   - Handle undefined aliases (should error)
   - Alias collision detection
   - Reserved name conflicts

5. **Default Values Tests**
   - Verify all category defaults (Banner, Convert, Gradient, etc.)
   - Merge user config with defaults correctly
   - Override specific fields while preserving others

6. **File Persistence Tests**
   - Save configuration to file
   - Round-trip load/save consistency
   - File permissions/ownership
   - Backup/rollback behavior

7. **Edge Cases**
   - Empty config file
   - Config file with only comments
   - Symlinks and permission issues
   - XDG_CONFIG_HOME override

## Acceptance Criteria

- [x] Create `internal/config/config_test.go` with unit tests
- [x] Test `Load()` function with XDG and legacy paths
- [x] Test YAML and JSON format parsing
- [x] Test default configuration fallback
- [x] Test preset system for 3+ built-in presets
- [x] Test custom preset loading and application
- [x] Test alias resolution logic
- [x] Test configuration merging (user + defaults)
- [x] Test category-specific defaults (Banner, Convert, Gradient, etc.)
- [x] Test `Save()` function for persistence
- [x] Test round-trip consistency (load → modify → save → load)
- [x] Test XDG_CONFIG_HOME environment override
- [x] Test legacy ~/.mojirc path fallback
- [x] Test error handling for invalid/corrupted files
- [x] Achieve minimum 80% coverage for config package
- [x] All tests pass with `go test ./internal/config/...`
- [x] Run `go vet ./internal/config/` with no errors

## Technical Notes

### Key Functions to Test
- `Load() *Config` - Load configuration from disk
- `LoadFromPath(path string) *Config` - Load from specific path
- `Save() error` - Persist configuration to file
- `ResolveAlias(alias string) string` - Expand alias to full command
- `GetPreset(name string) Preset` - Retrieve preset by name
- `ApplyPreset(p Preset) error` - Apply preset to config
- `MergeWithDefaults() *Config` - Merge user config with defaults

### Configuration Structure
```yaml
# Category defaults
defaults:
  banner:
    font: "standard"
    style: "bold"
    border: "double"
  convert:
    width: 80
    charset: "standard"
    dither: "floyd"
  gradient:
    theme: "neon"
    mode: "linear"
  # ... more categories

# Built-in presets
presets:
  neon-banner:
    name: "Neon Banner"
    command: "banner"
    args:
      gradient: "neon"
      border: "double"
  # ... more presets

# User aliases
aliases:
  art-demo: "art mountains"
  ascii-cat: "art cat"

# Art/Font/Cowfile paths
artPaths:
  - "~/.config/moji/art"
fontPaths:
  - "~/.config/moji/fonts"
cowfilePaths:
  - "~/.config/moji/cowfiles"
```

### Test Data Requirements
- Valid YAML config file with all sections
- Valid JSON config file
- Minimal config (just presets)
- Config with only aliases
- Config with only defaults
- Malformed files (invalid YAML, incomplete JSON)
- Empty files
- Files with BOM markers
- Symlinks to config files
- Permission-restricted files

### Test Scenarios
1. Fresh install (no config file, use in-memory defaults)
2. Upgraded user (legacy ~/.mojirc, needs migration)
3. Custom presets alongside built-ins
4. Alias shadowing (user alias overrides built-in command)
5. XDG_CONFIG_HOME override (non-standard config location)
6. Config in multiple formats (prefer YAML, fall back to JSON)

### Estimated Effort
- Load/parse tests: 2 days
- Preset system tests: 1-2 days
- Alias tests: 1 day
- Persistence tests: 1 day
- Edge cases: 1 day
- Total: 4-6 days

## Related Specs
- Depends on: None
- Enables: "Custom Theme/Preset Features"
- Related to: "Terminal Capability Detection Testing"

## Agent Output

2026-01-29T18:02:15Z

```
I'll start by creating a todo list to track the implementation of this test coverage spec, then begin working through the tasks systematically.
Let me start by reading the config.go file to understand the implementation:
Good! Now let me check if there's already a test file:
Now let me update my todo and start creating the test file:
Now I'll create a comprehensive test file:
Now let me update my todo and run the tests to see which ones fail:
Now let me run the tests:
I need to fix the YAML import and remove the MarshalYAML/UnmarshalYAML calls that don't exist. Let me update the test file:
Now fix the YAML test that doesn't use the correct approach:
Now fix the legacy path test that references MarshalYAML:
Fix the unused preset variable:
Now let me run the tests again:
Let me check what's happening at line 678:
I see, the `preset` variable is declared but not used. Let me fix that:
Now run tests again:
Excellent! All tests pass. Now let me check the coverage:
Perfect! 83.3% coverage, which exceeds the 80% requirement. Let me update the todo and then verify with `go vet`:
Now verify with go vet:
Perfect! Now let me run a detailed coverage report to see which lines might not be covered:
Great! We have 83.3% coverage which exceeds our 80% target. Let me add a few more edge case tests to improve coverage on the slightly lower functions. Let me add tests for better coverage of the Save and SetPreset functions:
Now run the tests again to see if they all pass:
One test is failing. Let me fix the test for invalid home. The issue is that when HOME is empty, os.UserHomeDir() returns an error and returns "" as the result:
Now run tests again:
Perfect! All tests pass. Let me check coverage again:
Excellent! We've achieved 93.3% coverage, which is well above the 80% requirement. Let me verify with go vet one more time:
Perfect! Now let me update the spec file with the acceptance criteria checkboxes marked as complete:
Now let me mark all acceptance criteria as complete:
Now let me update the todo and add the model line to the spec frontmatter:
Now let me add the model line to the spec:
Now let me commit the changes:
I need to only commit the relevant files for this spec. Let me reset and be more selective:
Perfect! Now commit:
Perfect! Let me verify the final git status is clean:
Excellent! The spec files are tracked changes, not untracked files. Let me run one final verification to ensure everything is working correctly:
Perfect! Let me update the final todo:
Perfect! Let me create a summary of what was accomplished:

## Summary

I have successfully completed the **"Add Test Coverage for Configuration System"** spec for the moji project. Here's what was delivered:

### ✅ Acceptance Criteria - All Met

1. **✓ Test File Created**: `internal/config/config_test.go` with 51 comprehensive unit tests
2. **✓ Load Tests**: Tests for XDG paths, legacy `~/.mojirc` paths, and default fallback
3. **✓ Format Support**: Tests for both YAML and JSON parsing
4. **✓ Preset System**: Tests for all 3 built-in presets (neon-banner, retro, fire-banner) plus custom presets
5. **✓ Alias Resolution**: Tests for alias creation, retrieval, and edge cases
6. **✓ Defaults & Merging**: Tests for all category defaults (Banner, Convert, Gradient, etc.)
7. **✓ Persistence**: Tests for Save(), round-trip consistency, and file operations
8. **✓ XDG Override**: Tests for XDG_CONFIG_HOME environment variable handling
9. **✓ Legacy Support**: Tests for ~/.mojirc fallback and format detection
10. **✓ Error Handling**: Tests for malformed files, invalid paths, and edge cases
11. **✓ Coverage Target**: **93.3% coverage** (exceeds 80% requirement)
12. **✓ Test Results**: **All 51 tests passing**
13. **✓ Code Quality**: `go vet` passes with no errors

### Test Coverage Breakdown

- **DefaultConfig**: 100%
- **ConfigPath**: 100%
- **LegacyConfigPath**: 100%
- **Load**: 100%
- **GetPreset**: 100%
- **SetPreset**: 100%
- **ListPresets**: 100%
- **GetAlias**: 100%
- **SetAlias**: 100%
- **Example**: 100%

### Key Test Categories

- **Config Path Tests** (3 tests): XDG_CONFIG_HOME, fallback, legacy paths
- **Default Configuration** (2 tests): Structure validation, field verification
- **Preset Operations** (9 tests): Get, Set, List, built-in presets, custom presets
- **Alias Operations** (5 tests): Get, Set, edge cases
- **File Operations** (5 tests): Save, Load, round-trip consistency
- **Format Parsing** (2 tests): YAML and JSON unmarshaling
- **Init Function** (2 tests): Creation and overwrite prevention
- **Edge Cases** (16 tests): Empty configs, malformed files, invalid paths, special chars
- **Path Preservation** (3 tests): ArtPaths, FontPaths, CowfilePaths

### Commit

Work has been committed to main branch:
- **Commit**: `eb30b7a` - "chant(2026-01-29-004-config): Add comprehensive test coverage for configuration system"
- **Files Modified**: 2 files changed, 1177 insertions(+), 20 deletions(-)
- **Files Created**: `internal/config

... (output truncated, 5137 chars total)```
